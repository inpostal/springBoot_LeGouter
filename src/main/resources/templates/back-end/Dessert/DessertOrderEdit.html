<!doctype html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title> 甜點訂單修改 </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <!-- <link rel="stylesheet" type="text/css" href="back-nav-bar.css">  -->

    <!-- import font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> -->
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300&display=swap" rel="stylesheet">

    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com/">
    <link href="/Dessert/CSS/css2.css" rel="stylesheet">

    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="/Dessert/CSS/bootstrap-icons.min.css" type="text/css">
    <!-- Bootstrap Docs -->
    <link rel="stylesheet" href="/Dessert/CSS/bootstrap-docs.css" type="text/css">


    <!-- Main style file -->
    <link rel="stylesheet" href="/Dessert/CSS/app.min.css" type="text/css">
    <style>
        #nav-bar {
            background-color: #1E1916;

        }

        .nav-pills {
            --bs-nav-pills-link-active-bg: white;
        }

        :root {
            --bs-link-color: white;
            --bs-link-hover-color: orange;

        }

        /* 標題列 */
        #mainheader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 80px;
            background: #f8d3ae;
            position: static;
            top: 0;
            left: 0;
            z-index: 999;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.06);

            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-link {
            font-size: 20px;
        }

        .dropdown {
            font-size: 20px;
        }

        .dropdown-item {
            font-size: 20px;
        }

        .dropdown-toggle::after {
            color: #1E1916;
        }

        .error {
            border: 1px solid red;
        }

        .form-control-feedback {
            display: none;
        }


    </style>


</head>

<body>
<section id="mainheader">

</section>


<div class="row flex-nowrap">
    <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 " id="nav-bar">

    </div>
    <!-- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- -->

    <div class="col py-3">

        <!-- 由此開始 -->

        <!-- preloader -->
        <div class="preloader">
            <img src="/Dessert/picture/logo.svg" alt="logo">
            <div class="preloader-icon"></div>
        </div>
        <!-- ./ preloader -->


        <!-- content -->
        <div class="content ">

            <div class="row flex-column-reverse flex-md-row">
                <div class="col-md-8">
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="profile" role="tabpanel"
                             aria-labelledby="profile-tab">
                            <div class="mb-4">
                                <div class="d-flex flex-column flex-md-row text-center text-md-start mb-3">

                                    <div class="flex-fill">
                                        <h5 class="mb-3">訂單編號：#<span id="ordersId"
                                                                         th:text="${orders.getOrderId()}"></span></h5>


                                        <button class="btn btn-primary me-2" type="button" id="submit">確認修改</button>
                                        <button class="btn btn-outline-danger btn-icon" data-bs-toggle="tooltip"
                                                title="捨棄修改" id="cancel">
                                            <i class="fa-regular fa-trash-can" style="color: #ff6e40;"></i>
                                        </button>


                                    </div>
                                </div>
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h6 class="card-title mb-4">訂單資訊</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">訂單總金額</label>
                                                    <div class="form-control" style="background-color: #dddddd;">
                                                        <span th:text="${orders.getCpOrderTotal()}"></span>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">收件人</label>
                                                    <input type="text" class="form-control" id="receiverName"
                                                           th:value="${orders.getReceiverName()}">
                                                    <div id="receiverNameFeedback" class="invalid-feedback">
                                                        <!-- Error message will go here -->
                                                    </div>
                                                </div>


                                                <div class="mb-3">
                                                    <label class="form-label" for="receiverPhone">電話</label>
                                                    <input type="text" class="form-control" id="receiverPhone"
                                                           name="receiverPhone" th:value="${orders.getReceiverPhone()}"
                                                           required>
                                                    <div id="receiverPhoneFeedback" class="invalid-feedback">
                                                        <!-- Error message will go here -->
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">E-mail</label>
                                                    <input type="text" class="form-control" id="receiverEmail"
                                                           th:value="${orders.getReceiverEmail()}">
                                                    <div id="receiverEmailFeedback" class="invalid-feedback">
                                                        <!-- Error message will go here -->
                                                    </div>
                                                </div>

                                            </div>

                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label">訂購日期</label>
                                                    <div class="form-control" style="background-color: #dddddd;">
                                                        <span id="orderTime" th:text="${orders.getOrderTime()}"></span>
                                                    </div>
                                                </div>


                                                <div class="mb-3">
                                                    <label class="form-label">收件地址</label>
                                                    <input type="text" class="form-control" id="receiverAddress"
                                                           th:value="${orders.receiverAddress}">
                                                    <div id="receiverAddressFeedback" class="invalid-feedback">
                                                        <!-- Error message will go here -->
                                                    </div>
                                                </div>


                                                <div class="mb-3">
                                                    <label class="form-label">訂單狀態</label>
                                                    <select id="orderStatus" class="form-select">
                                                        <option value="0" th:selected="${orders.orderStatus == 0}">
                                                            訂單處理中
                                                        </option>
                                                        <option value="1" th:selected="${orders.orderStatus == 1}">
                                                            運送中
                                                        </option>
                                                        <option value="2" th:selected="${orders.orderStatus == 2}">
                                                            取消訂單
                                                        </option>
                                                        <option value="3" th:selected="${orders.orderStatus == 3}">
                                                            訂單完成
                                                        </option>
                                                    </select>


                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>

        </div>
        <!-- ./ content -->
        <!-- 由此結束 -->
    </div>

    <!-- ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ -->

</div>


<script src="/Course/JS/Jquery.js"></script>

<!--改時間顯示格式-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var orderTimeElement = document.getElementById('orderTime');
        var orderTime = orderTimeElement.textContent.trim();
        var formattedTime = new Date(orderTime).toLocaleString('zh-TW', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: 'numeric',
            minute: 'numeric',
            second: 'numeric',
            hour12: true
        });
        orderTimeElement.textContent = formattedTime;
    });


</script>


<script>
    // $("#receiverPhone").blur(function () {
    //     let pattern = /^09\d{8}$/;
    //     let inputPhone = $(this).val();
    //
    //     if (!pattern.test(inputPhone)) {
    //         $(this).addClass("is-invalid");
    //         $(this).next(".invalid-feedback").show();
    //     } else {
    //         $(this).removeClass("is-invalid");
    //         $(this).next(".invalid-feedback").hide();
    //     }
    // });
    // $("#receiverName").blur(function () {
    //     let pattern = /^[\u4e00-\u9fa5_a-zA-Z0-9]+$/;
    //     let inputName = $(this).val();
    //
    //     if (!pattern.test(inputName)) {
    //         $(this).addClass("is-invalid");
    //         $(this).next(".invalid-feedback").text('收件人只能包含英文、數字或中文').show();
    //     } else {
    //         $(this).removeClass("is-invalid");
    //         $(this).next(".invalid-feedback").hide();
    //     }
    // });
    //
    // $("#receiverEmail").blur(function () {
    //     let pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    //     let inputEmail = $(this).val();
    //
    //     if (!pattern.test(inputEmail)) {
    //         $(this).addClass("is-invalid");
    //         $(this).next(".invalid-feedback").text('E-mail格式不正確').show();
    //     } else {
    //         $(this).removeClass("is-invalid");
    //         $(this).next(".invalid-feedback").hide();
    //     }
    // });
    //
    // $("#receiverAddress").blur(function () {
    //     let pattern = /^[\u4e00-\u9fa5_a-zA-Z0-9]+$/;
    //     let inputAddress = $(this).val();
    //
    //     if (!pattern.test(inputAddress)) {
    //         $(this).addClass("is-invalid");
    //         $(this).next(".invalid-feedback").text('收件地址只能包含數字或中文').show();
    //     } else {
    //         $(this).removeClass("is-invalid");
    //         $(this).next(".invalid-feedback").hide();
    //     }
    // });

    $("#submit").click(function () {
        event.preventDefault();// prevent the form from submitting
        let errorMsg = "";
        // 取得需要修改的值
        let ordersId = $("#ordersId").text();
        let receiverName = $("#receiverName").val();
        let receiverEmail = $("#receiverEmail").val();
        let receiverPhone = $("#receiverPhone").val();
        let orderStatus = $("#orderStatus").val();
        let receiverAddress = $("#receiverAddress").val();
        // Check each field for validation
        if (receiverName.trim() === '') {
            errorMsg += '收件人不能為空\n';
            $("#receiverName").addClass('is-invalid');
            $("#receiverNameFeedback").text('收件人不能為空').show();
        } else if (!/^[\a-zA-Z\u4e00-\u9fa5]+$/.test(receiverName)) {
            errorMsg += '收件人只能包含英文或中文\n';
            $("#receiverName").addClass('is-invalid');
            $("#receiverNameFeedback").text('收件人只能包含英文或中文').show();
        } else {
            $("#receiverName").removeClass('is-invalid');
            $("#receiverNameFeedback").hide();
        }


        if (receiverPhone.trim() === '') {
            errorMsg += '電話不能為空\n';
            $("#receiverPhone").addClass('is-invalid');
            $("#receiverPhone").next('.invalid-feedback').text('電話不能為空').show();
        } else if (!/^09\d{8}$/.test(receiverPhone)) {
            errorMsg += '電話格式不正確，必須為09開頭的十位數字\n';
            $("#receiverPhone").addClass('is-invalid');
            $("#receiverPhone").next('.invalid-feedback').text('電話格式不正確，必須為09開頭的十位數字').show();
        } else {
            $("#receiverPhone").removeClass('is-invalid');
            $("#receiverPhone").next('.invalid-feedback').hide();
        }

        if (receiverEmail.trim() === '') {
            errorMsg += 'E-mail不能為空\n';
            $("#receiverEmail").addClass('is-invalid');
            $("#receiverEmail").next('.invalid-feedback').text('E-mail不能為空').show();
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(receiverEmail)) {
            errorMsg += 'E-mail格式不正確\n';
            $("#receiverEmail").addClass('is-invalid');
            $("#receiverEmail").next('.invalid-feedback').text('E-mail格式不正確').show();
        } else {
            $("#receiverEmail").removeClass('is-invalid');
            $("#receiverEmail").next('.invalid-feedback').hide();
        }

        if (receiverAddress.trim() === '') {
            errorMsg += '收件地址不能為空\n';
            $("#receiverAddress").addClass('is-invalid');
            $("#receiverAddress").next('.invalid-feedback').text('收件地址不能為空').show();
        } else {
            let chineseNumberRegex = /^[\u4e00-\u9fa50-9]+$/;
            if (!chineseNumberRegex.test(receiverAddress)) {
                errorMsg += '收件地址只能包含中文或數字\n';
                $("#receiverAddress").addClass('is-invalid');
                $("#receiverAddress").next('.invalid-feedback').text('收件地址只能包含中文或數字').show();
            }

            let cityRegex = /(縣|市)/;
            if (!cityRegex.test(receiverAddress)) {
                errorMsg += '地址必須包含縣或市\n';
                $("#receiverAddress").addClass('is-invalid');
                $("#receiverAddress").next('.invalid-feedback').text('地址必須包含縣或市').show();
            }

            let numberRegex = /號/;
            if (!numberRegex.test(receiverAddress)) {
                errorMsg += '地址必須包含號\n';
                $("#receiverAddress").addClass('is-invalid');
                $("#receiverAddress").next('.invalid-feedback').text('地址必須包含號').show();
            }

            // Only remove 'is-invalid' class and hide feedback if all checks passed
            if (chineseNumberRegex.test(receiverAddress) && cityRegex.test(receiverAddress) && numberRegex.test(receiverAddress)) {
                $("#receiverAddress").removeClass('is-invalid');
                $("#receiverAddress").next('.invalid-feedback').hide();
            }
        }


        // If any error, show the alert and stop form submission
        if (errorMsg !== "") {

            Swal.fire({
                icon: 'error',
                title: '輸入有誤',
                text: errorMsg,

            })
            return;
        }


        // 建立 FormData 物件並加入需要修改的值
        let formData = new FormData();

        formData.append("ordersId", ordersId);
        formData.append("receiverName", receiverName);
        formData.append("receiverEmail", receiverEmail);
        formData.append("receiverPhone", receiverPhone);
        formData.append("orderStatus", orderStatus);
        formData.append("receiverAddress", receiverAddress);


        // 發送 AJAX 請求
        $.ajax({
            url: "/orders/update",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (data) {
                console.log(data);
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: '修改成功',
                    showConfirmButton: false,
                    timer: 1500
                })
                setTimeout(function () {
                    window.location.href = '/orders/list';
                }, 2000);
            },

            error: function (data) {
                console.log(data);
                alert("修改失敗");
            }
        });
    })
    ;


    $('#cancel').click(function () {
        Swal.fire({
            title: '確認放棄修改?',
            text: "你將無法恢復這個操作！",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '是的，我要放棄修改！',
            cancelButtonText: '不，我想再看一下'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/orders/list';
            } else {
                // 取消操作，保留在當前頁面
            }
        });
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- import js -->
<script src="/Conponents/back_end.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>

<!-- import font awesome -->
<script src="https://kit.fontawesome.com/3d215f6a1d.js" crossorigin="anonymous"></script>

<!-- ./ layout-wrapper -->

<!-- Bundle scripts -->
<script src="/Dessert/JS/bundle.js"></script>


<!-- Main Javascript file -->
<script src="/Dessert/JS/app.min.js"></script>
</body>

</html>